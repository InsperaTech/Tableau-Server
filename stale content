import tableauserverclient as TSC
from datetime import datetime, timedelta, timezone

# Tableau Server information
tableau_server = 'https://your-tableau-server'
username = 'your-username'
password = 'your-password'
site = 'your-site'

# Connect to Tableau Server
tableau_auth = TSC.TableauAuth(username, password, site)
server = TSC.Server(tableau_server)

# Set threshold for stale content (in days)
threshold_days = 45
cutoff_date = datetime.now(timezone.utc) - timedelta(days=threshold_days)

# Connect to Tableau Server and get workbook information
with server.auth.sign_in(tableau_auth):
    all_workbooks, pagination_item = server.workbooks.get()

    # Ensure all datetime objects are timezone-aware
    stale_workbooks = [
        workbook for workbook in all_workbooks
        if datetime.strptime(workbook.updated_at, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc) < cutoff_date
    ]

# Display stale workbook information
print("Stale Workbooks:")
for workbook in stale_workbooks:
    print(f"Name: {workbook.name}, Last Updated: {workbook.updated_at}")


------------------------------------------------------------------------------------------------

import argparse
import getpass
import psycopg2
from datetime import datetime, timedelta

def connect_to_postgresql(host, port, user, password, database):
    try:
        connection = psycopg2.connect(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database
        )
        return connection
    except Exception as e:
        print(f"Error: Unable to connect to PostgreSQL database - {e}")
        return None

def get_stale_content(connection, days_threshold=30):
    try:
        cursor = connection.cursor()

        # Query for stale content
        query = """
            SELECT projects.name AS project_name, workbooks.name AS workbook_name, workbooks.updated_at
            FROM workbooks
            JOIN projects ON workbooks.project_id = projects.id
            WHERE current_date - workbooks.updated_at::date > %s;
        """

        cursor.execute(query, (days_threshold,))

        stale_content = cursor.fetchall()

        # Print the stale content
        for row in stale_content:
            project_name, workbook_name, updated_at = row
            print(f"Stale Workbook found: {workbook_name} in Project: {project_name}, Last Updated: {updated_at}")

        cursor.close()
    except Exception as e:
        print(f"Error: Unable to retrieve stale content - {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Connect to Tableau PostgreSQL and get the list of stale content')
    parser.add_argument('--host', '-H', required=True, help='PostgreSQL host')
    parser.add_argument('--port', '-P', type=int, required=True, help='PostgreSQL port')
    parser.add_argument('--user', '-u', required=True, help='PostgreSQL username')
    parser.add_argument('--password', '-p', help='PostgreSQL password')
    parser.add_argument('--database', '-d', required=True, help='PostgreSQL database name')
    parser.add_argument('--days-threshold', '-t', type=int, default=30, help='Number of days to consider as stale (default: 30)')

    args = parser.parse_args()

    # Prompt for password if not provided as a command-line argument
    password = args.password or getpass.getpass('Enter PostgreSQL password: ')

    # Connect to PostgreSQL
    connection = connect_to_postgresql(args.host, args.port, args.user, password, args.database)

    if connection:
        # Get stale content
        get_stale_content(connection, args.days_threshold)

        # Close the database connection
        connection.close()
except Exception as e:
        print(f"Error: Unable to retrieve stale content - {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Connect to Tableau PostgreSQL and get the list of stale content')
    parser.add_argument('--host', '-H', required=True, help='PostgreSQL host')
    parser.add_argument('--port', '-P', type=int, required=True, help='PostgreSQL port')
    parser.add_argument('--user', '-u', required=True, help='PostgreSQL username')
    parser.add_argument('--password', '-p', help='PostgreSQL password')
    parser.add_argument('--database', '-d', required=True, help='PostgreSQL database name')
    parser.add_argument('--days-threshold', '-t', type=int, default=30, help='Number of days to consider as stale (default: 30)')

    args = parser.parse_args()

    # Prompt for password if not provided as a command-line argument
    password = args.password or getpass.getpass('Enter PostgreSQL password: ')

    # Connect to PostgreSQL
    connection = connect_to_postgresql(args.host, args.port, args.user, password, args.database)

    if connection:
        # Get stale content
        get_stale_content(connection, args.days_threshold)

        # Close the database connection
        connection.close()
----------------------------------------------------------------------------
#stale content data based on last updated date
import psycopg2
import pandas as pd

def get_stale_content(conn, stale_threshold_days=30):
    try:
        cursor = conn.cursor()

        # Example SQL query to retrieve stale workbooks
        workbook_query = """
            SELECT name, project_name, updated_at
            FROM workbooks
            WHERE current_date - updated_at::date > %s;
        """

        cursor.execute(workbook_query, (stale_threshold_days,))
        stale_workbooks = cursor.fetchall()

        # Create a DataFrame from the fetched data
        df = pd.DataFrame(stale_workbooks, columns=['Name', 'Project', 'Last Updated'])

        # Print information about stale workbooks
        print("Stale Workbooks:")
        print(df)

        # Export stale data to Excel
        excel_filename = 'stale_workbooks.xlsx'
        df.to_excel(excel_filename, index=False)
        print(f"Stale data exported to {excel_filename}")

        cursor.close()
    except Exception as error:
        print('ERROR', error)
        pass

if __name__ == "__main__":
    conn_string = (
        "host=" + "nldn105466pap.***prod.msad.***.net" +
        " port=" + "8060" +
        " dbname=" + 'workgroup' +
        " user=" + 'readonly' +
        " password=" + 'Tableau2014'
    )

    try:
        # Connect to PostgreSQL
        conn = psycopg2.connect(conn_string)
        print("Connected!")

        # Specify the threshold for stale content (in days)
        stale_threshold_days = 30

        # Get and print stale content information
        get_stale_content(conn, stale_threshold_days)

    except Exception as error:
        print('ERROR', error)

    finally:
        # Close the database connection
        if conn:
            conn.close()
            print("Connection closed.")
