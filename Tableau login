import tableauserverclient as TSC
from datetime import datetime, timedelta
from sqlalchemy import create_engine
import pandas as pd

# Tableau Server information
tableau_server = 'https://your-tableau-server'
username = 'your-username'
password = 'your-password'
site = 'your-site'

# Connect to Tableau Server
tableau_auth = TSC.TableauAuth(username, password, site)
server = TSC.Server(tableau_server)

# Set threshold for stale content (in days)
threshold_days = 45
cutoff_date = datetime.now() - timedelta(days=threshold_days)

# Connect to Tableau Server and get workbook information
with server.auth.sign_in(tableau_auth):
    all_workbooks, pagination_item = server.workbooks.get()
    stale_workbooks = [workbook for workbook in all_workbooks if workbook.updated_at < cutoff_date]

# Display stale workbook information
print("Stale Workbooks:")
for workbook in stale_workbooks:
    print(f"Name: {workbook.name}, Last Updated: {workbook.updated_at}")

# SQL connection to store stale workbook information
db_connection_string = 'sqlite:///stale_workbooks.db'  # Change this based on your database type
engine = create_engine(db_connection_string)

# Store stale workbook information in a database table
stale_workbooks_df = pd.DataFrame([(workbook.name, workbook.updated_at) for workbook in stale_workbooks], 
                                  columns=['workbook_name', 'last_updated'])
stale_workbooks_df.to_sql('stale_workbooks', engine, if_exists='replace', index=False)

# Query the database for stale workbooks
stale_workbooks_query = pd.read_sql_query("SELECT * FROM stale_workbooks", engine)
print("\nStale Workbooks in Database:")
print(stale_workbooks_query)
