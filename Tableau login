# Install Required Libraries:
# pip install tableau-api-lib

# Import Libraries:
from tableau_api_lib import TableauServerConnection, Server
from tableau_api_lib.utils.querying import get_sites, get_projects_dataframe, get_workbooks_dataframe
from datetime import datetime, timedelta

# Connect to Tableau Server:
server = Server('https://your-tableau-server-url')
server.use_server_version()
connection = TableauServerConnection('your-username', 'your-password', server)
connection.sign_in()

# Get all sites:
all_sites, pagination_item = get_sites(connection)

# Loop through each site:
for site in all_sites:
    site_id = site.id
    site_name = site.content_url

    # Switch to the current site:
    connection.switch_site(site_id)

    # Identify Stale Content for the current site:
    threshold_date = datetime.now() - timedelta(days=365)  # adjust the days as needed
    all_workbooks_df = get_workbooks_dataframe(connection)
    stale_workbooks = all_workbooks_df[all_workbooks_df['updated_at'] < threshold_date]

    # Print or handle stale workbooks for the current site:
    print(f"Stale workbooks in {site_name} site:")
    print(stale_workbooks)

    # Move Stale Content to Archive (modify as needed):
    # archive_project_name = 'Archive'
    # all_projects_df = get_projects_dataframe(connection)
    # archive_project_id = all_projects_df.loc[all_projects_df['name'] == archive_project_name, 'id'].values[0]

    # for workbook_id in stale_workbooks['id']:
    #     connection.workbooks.move(workbook_id, archive_project_id)

# Sign Out:
connection.sign_out()
